<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L8TRUST</title>
<style>
body {
    font-family: "Courier New", Courier, monospace;
    background-color: #000080;
    color: #00FF00;
    font-size: 16px;
    line-height: 1.5;
    min-width: 1200px;
    overflow-x: auto;
}

html {
    overflow-x: auto;
}

.container {
    max-width: none;
    width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
    padding-left: 250px;
    padding-right: 250px;
    box-sizing: border-box;
}

h1 {
    text-align: center;
    font-size: 40px;
    color: #FFFF00;
    text-shadow: 2px 2px #FF00FF;
}

#market-status, #major-indices, #rss-feed, #stock-ticker, #sector-performance, #stock-info, #berkshire-investments {
    border: 2px solid #00FF00;
    padding: 10px;
    margin-top: 20px;
    background-color: #000000;
    width: 100%;
    box-sizing: border-box;
}

#market-status {
    text-align: center;
    text-transform: uppercase;
}

h3 {
    color: #FF00FF;
    text-align: center;
    margin-top: 10px;
    text-decoration: underline;
}

.market-open { color: #00FF00; }
.market-extended { color: #FFA500; }
.market-closed { color: #FF0000; }

.blink {
    animation: blinker 1s linear infinite;
}

@keyframes blinker {
    50% { opacity: 0; }
}

#refresh-info {
    text-align: center;
    font-size: 14px;
    margin-top: 20px;
    color: #FFFFFF;
}

#rss-feed {
    max-height: 4000px;
    overflow-y: auto;
}

#news-list {
    list-style-type: none;
    padding-left: 0;
}

#news-list li {
    margin-bottom: 15px;
    padding: 10px;
}

#news-list a {
    color: #00FF00;
    text-decoration: none;
}

#news-list a:hover {
    text-decoration: underline;
}

.news-timestamp {
    font-size: 0.8em;
    color: #888;
    margin-top: 5px;
}

#major-indices {
    text-align: center;
}

#stock-ticker {
    overflow: hidden;
    padding: 10px 0;
    white-space: nowrap;
}

#ticker-content {
    display: inline-block;
    padding-left: 100%;
    animation: ticker 50s linear infinite;
}

#ticker-content:hover {
    animation-play-state: paused;
}

#ticker-content span {
    margin-right: 40px;
}

@keyframes ticker {
    0% { transform: translate(0, 0); }
    100% { transform: translate(-100%, 0); }
}

.sector-bar {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
}

.sector-name {
    width: 150px;
    text-align: right;
    padding-right: 10px;
}

.bar {
    height: 20px;
    transition: width 0.5s ease-in-out;
}

.performance-value {
    margin-left: 5px;
}

#utc-clock {
    position: fixed;
    top: 10px;
    right: 10px;
    font-size: 14px;
    color: #00FF00;
    z-index: 1000;
}

#stock-search {
    margin-top: 20px;
    text-align: center;
}

#stock-search input, #stock-search button, #load-sectors {
    font-family: "Courier New", Courier, monospace;
    font-size: 16px;
    background-color: #000000;
    color: #00FF00;
    border: 1px solid #00FF00;
    padding: 5px;
}

#stock-search button, #load-sectors {
    cursor: pointer;
}

#stock-search button:hover, #load-sectors:hover {
    background-color: #003300;
}

#market-status-corner {
    position: fixed;
    top: 10px;
    left: 10px;
    background-color: #000;
    border: 2px solid #00FF00;
    padding: 2px;
    z-index: 1000;
}

#sector-performance {
    margin-top: 20px;
    text-align: center;
}

#sector-title {
    color: #FF00FF;
    text-align: center;
    margin-top: 0;
    margin-bottom: 20px;
    text-decoration: underline;
}

#berkshire-form4-button {
    position: fixed;
    top: 40px;
    right: 10px;
    margin: 10px auto;
    padding: 5px 10px;
    background-color: #000000;
    color: #00FF00;
    border: 1px solid #00FF00;
    cursor: pointer;
    font-family: "Courier New", Courier, monospace;
    font-size: 16px;
    min-width: 230px;
    z-index: 1000;
}

#berkshire-form4-button:hover {
    background-color: #003300;
}

#airport-weather {
    position: fixed;
    top: 10px;
    left: 10px;
    background-color: #000;
    border: 2px solid #00FF00;
    padding: 15px;
    font-size: 16px;
    max-width: 230px;
    min-width: 230px;
    overflow-y: auto;
    max-height: 100vh;
    z-index: 1000;
}

#metar-search {
    position: fixed;
    top: 360px;
    left: 10px;
    background-color: #000;
    border: 2px solid #00FF00;
    padding: 15px;
    font-size: 16px;
    max-width: 230px;
    min-width: 230px;
    overflow-y: auto;
    max-height: 100vh;
    z-index: 1000;
}

#metar-search h4 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #FF00FF;
}

.airport-weather-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 15px;
}

#metar-search input, #metar-search button {
    font-family: "Courier New", Courier, monospace;
    font-size: 16px;
    background-color: #000000;
    color: #00FF00;
    border: 1px solid #00FF00;
    padding: 5px 10px;
    margin: 5px 0;
    width: 100%;
    box-sizing: border-box;
}

#metar-search button {
    cursor: pointer;
    transition: background-color 0.3s;
}

#metar-search button:hover {
    background-color: #003300;
}

#metar-taf-display {
    margin-top: 15px;
    text-align: left;
    white-space: pre-wrap;
    font-family: "Courier New", Courier, monospace;
    font-size: 16px;
    background-color: #000000;
    border: 1px solid #00FF00;
    padding: 15px;
    max-height: 200px;
    overflow-y: auto;
}

#crypto-dashboard {
    position: fixed;
    top: 90px;
    right: 10px;
    background-color: #000;
    border: 2px solid #00FF00;
    padding: 10px;
    font-size: 16px;
    max-width: 230px;
    min-width: 230px;
    z-index: 1000;
}

#crypto-dashboard h4 {
    margin-top: 0;
    color: #FF00FF;
    text-align: center;
    min-width: 230px;
}
</style>
</head>
<body>
<div class="container">
<div id="airport-weather" style="position: absolute; top: 10px; left: 10px; background-color: #000; border: 2px solid #00FF00; padding: 10px; font-size: 16px; max-width: 230px; min-width: 230px; overflow-y: auto; max-height: 100vh; z-index: 1000;">
    <h4 style="margin-top: 0; color: #FF00FF; text-align: center;">LFML Weather</h4>
    <div id="lfml-metar-taf"></div>
    
</div>
<div id="metar-search" style="position: absolute; top: 360px; left: 10px; background-color: #000; border: 2px solid #00FF00; padding: 10px; font-size: 16px; max-width: 230px; min-width: 230px; overflow-y: auto; max-height: 100vh; z-index: 1000;">
    <h4 style="margin-top: 0; color: #FF00FF; text-align: center;">METAR Search</h4>
    <div class="airport-weather-controls">
        <input type="text" id="airport-code" placeholder="Enter airport code">
        <button onclick="fetchAirportWeather()">Get Weather</button>
        <button onclick="refreshAirportWeather()">Refresh</button>
    </div>
    <div id="metar-taf-display"></div>
</div>
    <div id="utc-clock"></div>
    <button id="berkshire-form4-button">Latest Berkshire Form 4</button>
    <div id="crypto-dashboard" style="position: absolute; top: 90px; right: 10px; background-color: #000; border: 2px solid #00FF00; padding: 10px; font-size: 16px; max-width: 230px; min-width: 230px;">
    <h4 style="margin-top: 0; color: #FF00FF; text-align: center; min-width: 230px;">Crypto Prices</h4>
    <div id="crypto-prices"></div>
</div>
    <h1 class="blink">L8TRUST</h1>
    <div id="market-status"></div>
    <div id="major-indices">
        <h3>Major Indices</h3>
        <p>
            <span id="spy-performance">S&P 500: -1.12%</span> |
            <span id="qqq-performance">Nasdaq 100: -2.33%</span> |
            <span id="dia-performance">Dow Jones: 0.18%</span>
        </p>
    </div>
    <div id="stock-ticker">
        <div id="ticker-content"></div>
    </div>
    <div id="stock-search">
        <input type="text" id="stock-symbol" placeholder="Enter stock symbol">
        <button onclick="searchStock()">Search</button>
        <button onclick="resetSearch()">Reset</button>
    </div>
    <div id="stock-info"></div>
    <div id="sector-performance">
        <button id="load-sectors">Load Sector Performance</button>
        <div id="sector-chart" style="display: none;">
            <h3 id="sector-title">Sector Performance</h3>
            <!-- Sector data will be loaded here -->
        </div>
    </div>
    <div id="rss-feed">
        <h3>Latest News</h3>
        <ul id="news-list"></ul>
    </div>

    <div id="refresh-info">This page will refresh in <span id="countdown">120</span> seconds</div>
</div>
<script>
    const apiKey = 'cha3cg1r01qhe0r9rhg0cha3cg1r01qhe0r9rhgg';
    const marketStatusApiKey = 'NQpPDWBnyk3zbab7leFzAavOzTnNpWjY';
    let countdown = 120;

    async function fetchMarketStatus() {
        const marketStatusUrl = `https://api.polygon.io/v1/marketstatus/now?apiKey=${marketStatusApiKey}`;
        try {
            const response = await fetch(marketStatusUrl);
            const data = await response.json();
            if (!data || data.error) {
                throw new Error(data ? data.error : 'Unknown error');
            }
            displayMarketStatus(data);
        } catch (error) {
            console.error('Error fetching market status:', error);
            document.getElementById('market-status').innerHTML = `
                <p>Error fetching market status. ${error.message}</p>
                <p>Check the console for more details.</p>
            `;
        }
    }

function displayMarketStatus(statusData) {
    const marketStatusElement = document.getElementById('market-status');
    const nyseStatus = statusData.exchanges.nyse;
    const nasdaqStatus = statusData.exchanges.nasdaq;

    function getStatusColor(status) {
        switch (status) {
            case 'open':
                return '#00FF00';  // Green
            case 'closed':
                return '#FF4500';  // Red
            case 'extended-hours':
                return '#FFA500';  // Orange
            default:
                return '#FFFFFF';  // White (default)
        }
    }

    function createStatusSpan(status) {
        const spanElement = document.createElement('span');
        spanElement.textContent = status;
        spanElement.style.backgroundColor = getStatusColor(status);
        spanElement.style.color = 'black';
        spanElement.style.padding = '2px 5px';
        spanElement.style.borderRadius = '3px';
        spanElement.style.fontWeight = 'bold';
        return spanElement;
    }

    marketStatusElement.innerHTML = '';
    marketStatusElement.appendChild(document.createTextNode('NYSE: '));
    marketStatusElement.appendChild(createStatusSpan(nyseStatus));
    marketStatusElement.appendChild(document.createTextNode(' NASDAQ: '));
    marketStatusElement.appendChild(createStatusSpan(nasdaqStatus));
}

    async function fetchIndexPerformance(symbol) {
        const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`;
        const response = await fetch(url);
        const data = await response.json();
        const changePercent = ((data.c - data.pc) / data.pc * 100).toFixed(2);
        return `${changePercent}%`;
    }

    async function displayIndexPerformance(symbol, elementId, indexName) {
        const performanceElement = document.getElementById(elementId);
        try {
            const changePercent = await fetchIndexPerformance(symbol);
            if (performanceElement) {
                const spanElement = document.createElement('span');
                const numericChange = parseFloat(changePercent);
                spanElement.textContent = `${numericChange >= 0 ? '+' : ''}${changePercent}`;
                const changeColor = numericChange >= 0 ? '#00FF00' : '#FF4500';
                spanElement.style.backgroundColor = changeColor;
                spanElement.style.color = 'black';
                spanElement.style.padding = '2px 5px';
                spanElement.style.borderRadius = '3px';
                spanElement.style.fontWeight = 'bold';
                performanceElement.innerHTML = `${indexName}: `;
                performanceElement.appendChild(spanElement);
            }
        } catch (error) {
            console.error(`Error displaying ${indexName} performance:`, error);
            if (performanceElement) {
                performanceElement.textContent = `Error displaying ${indexName} performance.`;
            }
        }
    }

   async function loadRSSFeed() {
        const rssUrl = 'https://breakingthenews.net/news-feed.xml';
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(rssUrl)}`;
        
        try {
            const response = await fetch(proxyUrl);
            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            
            const items = xmlDoc.querySelectorAll('item');
            const newsList = document.getElementById('news-list');
            newsList.innerHTML = '';
            
            items.forEach(item => {
                const title = item.querySelector('title').textContent;
                const link = item.querySelector('link').textContent;
                const pubDate = new Date(item.querySelector('pubDate').textContent);
                const description = item.querySelector('description').textContent;
                
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = link;
                a.textContent = title;
                
                const descriptionSpan = document.createElement('span');
                descriptionSpan.innerHTML = truncateDescription(description, 100);
                
                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'news-timestamp';
                timestampSpan.textContent = formatDate(pubDate);
                
                li.appendChild(a);
                li.appendChild(descriptionSpan);
                li.appendChild(timestampSpan);
                newsList.appendChild(li);
            });
        } catch (error) {
            console.error('Error fetching RSS feed:', error);
            document.getElementById('news-list').innerHTML = '<li>Error loading news feed. Please try again later.</li>';
        }
    }

function truncateDescription(description, maxLength) {
    const strippedDescription = description.replace(/<[^>]*>/g, '');
    if (strippedDescription.length > maxLength) {
        return strippedDescription.substring(0, maxLength);
    }
    return strippedDescription;
}

    function formatDate(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.round(diffMs / 60000);
        const diffHours = Math.round(diffMins / 60);

        if (diffMins < 60) {
            return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
        } else if (diffHours < 24) {
            return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
        } else {
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: 'numeric', 
                minute: 'numeric'
            });
        }
    }

    async function fetchStockData(symbol) {
        const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`;
        const response = await fetch(url);
        const data = await response.json();
        const changePercent = ((data.c - data.pc) / data.pc * 100).toFixed(2);
        return { symbol, price: data.c.toFixed(2), changePercent };
    }

    async function updateStockTicker() {
        const stocks = ['AAPL', 'MSFT', 'NVDA', 'GOOGL', 'AMZN', 'META', 'BRK-B', 'TSM', 'LLY', 'TSLA'];
        const tickerContent = document.getElementById('ticker-content');
        tickerContent.innerHTML = '';

        for (const stock of stocks) {
            try {
                const { symbol, price, changePercent } = await fetchStockData(stock);
                const numericChange = parseFloat(changePercent);
                const changeColor = numericChange >= 0 ? '#00FF00' : '#FF4500';
                const changeSign = numericChange >= 0 ? '+' : '';
                
                tickerContent.innerHTML += `
                    <span>${symbol}: $${price} 
                        <span style="background-color: ${changeColor}; color: black; padding: 2px 5px; border-radius: 3px; font-weight: bold;">
                            ${changeSign}${changePercent}%
                        </span>
                    </span>
                `;
            } catch (error) {
                console.error(`Error fetching data for ${stock}:`, error);
            }
        }
    }

    async function fetchSectorPerformance() {
        const sectors = [
            { symbol: 'XLK', name: 'Technology' },
            { symbol: 'XLV', name: 'Healthcare' },
            { symbol: 'XLF', name: 'Financials' },
            { symbol: 'XLE', name: 'Energy' },
            { symbol: 'XLU', name: 'Utilities' },
            { symbol: 'XLI', name: 'Industrial' },
            { symbol: 'XLP', name: 'Consumer Staples' },
            { symbol: 'XLB', name: 'Materials' },
            { symbol: 'XLY', name: 'Consumer Cyclical' }
        ];

        const sectorPerformance = [];

        for (const sector of sectors) {
            try {
                const { symbol, name } = sector;
                const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`;
                const response = await fetch(url);
                const data = await response.json();
                const performance = ((data.c - data.pc) / data.pc * 100);
                sectorPerformance.push({ name, performance });
            } catch (error) {
                console.error(`Error fetching data for ${sector.name}:`, error);
                sectorPerformance.push({ name: sector.name, performance: 0 });
            }
        }

        updateSectorChart(sectorPerformance);
    }

    function updateSectorChart(sectorData) {
        const chartContainer = document.getElementById('sector-chart');
        chartContainer.innerHTML = '<h3 id="sector-title">Sector Performance</h3>';

        sectorData.sort((a, b) => b.performance - a.performance);
        const maxPerformance = Math.max(...sectorData.map(s => Math.abs(s.performance)));

        sectorData.forEach(sector => {
            const sectorDiv = document.createElement('div');
            sectorDiv.className = 'sector-bar';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'sector-name';
            nameSpan.textContent = sector.name;

            const barDiv = document.createElement('div');
            barDiv.className = 'bar';
            const width = Math.abs(sector.performance) / maxPerformance * 70;
            barDiv.style.width = `${width}%`;
            barDiv.style.backgroundColor = sector.performance >= 0 ? '#00FF00' : '#FF0000';

            const valueSpan = document.createElement('span');
            valueSpan.className = 'performance-value';
            valueSpan.textContent = `${sector.performance > 0 ? '+' : ''}${sector.performance.toFixed(2)}%`;
            valueSpan.style.color = sector.performance >= 0 ? '#00FF00' : '#FF0000';

            sectorDiv.appendChild(nameSpan);
            sectorDiv.appendChild(barDiv);
            sectorDiv.appendChild(valueSpan);

            chartContainer.appendChild(sectorDiv);
        });
    }

    async function searchStock() {
        const symbol = document.getElementById('stock-symbol').value.toUpperCase();
        const stockInfoElement = document.getElementById('stock-info');
        stockInfoElement.innerHTML = 'Loading...';
        try {
            const quoteUrl = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`;
            const profileUrl = `https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${apiKey}`;
            const [quoteResponse, profileResponse] = await Promise.all([
                fetch(quoteUrl),
                fetch(profileUrl)
            ]);
            const quoteData = await quoteResponse.json();
            const profileData = await profileResponse.json();
            if (quoteData.error || profileData.error) {
                throw new Error('Stock not found');
            }
            const marketCap = (profileData.marketCapitalization * 1000000).toLocaleString();
            const peRatio = (quoteData.c / (profileData.finnhubIndustry === 'Technology' ? 20 : 15)).toFixed(2);
            
            const percentChange = ((quoteData.c - quoteData.pc) / quoteData.pc * 100).toFixed(2);
            const changeSign = percentChange >= 0 ? '+' : '';
            const changeColor = percentChange >= 0 ? '#00FF00' : '#FF4500';

            stockInfoElement.innerHTML = `
                <h3>${profileData.name} (${symbol})</h3>
                <p><strong>Industry:</strong> ${profileData.finnhubIndustry}</p>
                <p><strong>Price:</strong> $${quoteData.c.toFixed(2)} 
                   <span style="background-color: ${changeColor}; color: black; padding: 2px 5px; border-radius: 3px; font-weight: bold;">
                     (${changeSign}${percentChange}%)
                   </span>
                </p>
                <p><strong>Market Cap:</strong> $${marketCap}</p>
                <p><strong>Day's High:</strong> $${quoteData.h.toFixed(2)}</p>
                <p><strong>Day's Low:</strong> $${quoteData.l.toFixed(2)}</p>
            `;
        } catch (error) {
            console.error('Error fetching stock data:', error);
            stockInfoElement.innerHTML = 'Error fetching stock data. Please try again.';
        }
    }

    function resetSearch() {
        document.getElementById('stock-symbol').value = '';
        document.getElementById('stock-info').innerHTML = '';
    }

    function updateUTCClock() {
        const now = new Date();
        const utcString = now.toUTCString();
        document.getElementById('utc-clock').textContent = utcString;
    }

    function refreshAllData() {
        fetchMarketStatus();
        displayIndexPerformance('SPY', 'spy-performance', 'S&P 500');
        displayIndexPerformance('QQQ', 'qqq-performance', 'Nasdaq 100');
        displayIndexPerformance('DIA', 'dia-performance', 'Dow Jones');
        updateStockTicker();
        loadRSSFeed();
        fetchCryptoPrices();
        fetchLFMLWeather();  // Add this line
        updateUTCClock();
        countdown = 120;
    }

    function updateCountdown() {
        countdown--;
        document.getElementById('countdown').textContent = countdown;
        if (countdown <= 0) {
            refreshAllData();
        }
    }

async function fetchLatestBerkshireForm4() {
    const proxyUrl = 'https://api.allorigins.win/raw?url=';
    const edgarUrl = 'https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK=0001067983&type=4&dateb=&owner=include&start=0&count=5&output=atom';
    const fullUrl = proxyUrl + encodeURIComponent(edgarUrl);

    try {
        const response = await fetch(fullUrl);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        
        const entries = xmlDoc.querySelectorAll('entry');
        const formDataArray = Array.from(entries).map(entry => {
            const title = entry.querySelector('title').textContent;
            const link = entry.querySelector('link').getAttribute('href');
            const date = new Date(entry.querySelector('updated').textContent);
            
            // Extract the accession number and create a direct link to the filing
            const accessionMatch = link.match(/accession_number=(\d+-\d+-\d+)/);
            let directLink = link; // Default to the original link
            if (accessionMatch && accessionMatch[1]) {
                const accessionNumber = accessionMatch[1].replace(/-/g, '');
                directLink = `https://www.sec.gov/Archives/edgar/data/1067983/${accessionNumber}/xslF345X03/doc4.xml`;
            }
            
            return { title, link: directLink, date };
        });
        
        return formDataArray;
    } catch (error) {
        console.error('Error fetching Berkshire Form 4:', error);
        return null;
    }
}

function displayForm4Popup(formDataArray) {
    const popup = document.createElement('div');
    popup.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #000000;
        border: 2px solid #00FF00;
        padding: 20px;
        z-index: 1000;
        color: #00FF00;
        font-family: "Courier New", Courier, monospace;
        max-height: 80vh;
        overflow-y: auto;
        width: 80%;
        max-width: 600px;
    `;

    let content = `
        <div style="position: relative;">
            <h3 style="margin-top: 0;">Latest Berkshire Hathaway Form 4 Filings</h3>
            <button id="close-popup-x" style="
                position: absolute;
                top: -10px;
                right: -10px;
                background-color: #000000;
                color: #00FF00;
                border: 1px solid #00FF00;
                width: 25px;
                height: 25px;
                font-family: 'Courier New', Courier, monospace;
                font-size: 16px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
            ">X</button>
        </div>
    `;

    formDataArray.forEach((formData, index) => {
        content += `
            <div style="margin-bottom: 15px; border-bottom: 1px solid #00FF00; padding-bottom: 10px;">
                <p><strong>Title:</strong> ${formData.title}</p>
                <p><strong>Filed on:</strong> ${formData.date.toLocaleDateString()}</p>
                <a href="${formData.link}" target="_blank" style="color: #00FF00;">View Full Form</a>
            </div>
        `;
    });

    content += `
        <button id="close-popup" style="
            background-color: #000000;
            color: #00FF00;
            border: 1px solid #00FF00;
            padding: 5px 10px;
            margin-top: 10px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
        ">Close</button>
    `;

    popup.innerHTML = content;
    document.body.appendChild(popup);

    document.getElementById('close-popup').addEventListener('click', () => {
        document.body.removeChild(popup);
    });

    document.getElementById('close-popup-x').addEventListener('click', () => {
        document.body.removeChild(popup);
    });
}

    document.addEventListener('DOMContentLoaded', () => {
        refreshAllData();
        fetchCryptoPrices();
        setInterval(updateCountdown, 1000);
        setInterval(updateUTCClock, 1000);
        
        const loadSectorsButton = document.getElementById('load-sectors');
        loadSectorsButton.addEventListener('click', async () => {
            const sectorChart = document.getElementById('sector-chart');
            if (sectorChart.style.display === 'none') {
                loadSectorsButton.disabled = true;
                loadSectorsButton.textContent = 'Loading...';
                sectorChart.style.display = 'block';
                try {
                    await fetchSectorPerformance();
                    loadSectorsButton.textContent = 'Hide Sector Performance';
                } catch (error) {
                    console.error('Error loading sector performance:', error);
                    sectorChart.innerHTML = 'Error loading sector performance. Please try again.';
                }
                loadSectorsButton.disabled = false;
            } else {
                sectorChart.style.display = 'none';
                loadSectorsButton.textContent = 'Load Sector Performance';
            }
        });

        const berkshireButton = document.getElementById('berkshire-form4-button');
        berkshireButton.addEventListener('click', async () => {
            berkshireButton.disabled = true;
            berkshireButton.textContent = 'Loading...';
            const formDataArray = await fetchLatestBerkshireForm4();
            if (formDataArray && formDataArray.length > 0) {
                displayForm4Popup(formDataArray);
            } else {
                alert('Error fetching Berkshire Form 4 data. Please try again later.');
            }
            berkshireButton.disabled = false;
            berkshireButton.textContent = 'Latest Berkshire Form 4';
        });
    });
function getCurrentTimestamp() {
    return new Date().getTime();
}

async function fetchAirportWeather() {
    const airportCode = document.getElementById('airport-code').value.toUpperCase();
    await getAirportWeather(airportCode);
}

async function refreshAirportWeather() {
    const airportCode = document.getElementById('airport-code').value.toUpperCase();
    if (airportCode) {
        await getAirportWeather(airportCode);
    } else {
        alert('Please enter an airport code before refreshing.');
    }
}

async function getAirportWeather(airportCode) {
    const displayElement = document.getElementById('metar-taf-display');
    displayElement.textContent = 'Loading...';

    const corsProxy = 'https://corsproxy.io/?';
    const timestamp = getCurrentTimestamp();
    const metarUrl = `${corsProxy}${encodeURIComponent(`https://aviationweather.gov/api/data/metar?ids=${airportCode}&format=raw&hours=0&_=${timestamp}`)}`;
    const tafUrl = `${corsProxy}${encodeURIComponent(`https://aviationweather.gov/api/data/taf?ids=${airportCode}&format=raw&_=${timestamp}`)}`;

    try {
        const [metarResponse, tafResponse] = await Promise.all([
            fetch(metarUrl),
            fetch(tafUrl)
        ]);

        if (!metarResponse.ok || !tafResponse.ok) {
            throw new Error('Failed to fetch weather data');
        }

        const metarText = await metarResponse.text();
        const tafText = await tafResponse.text();

        let content = `<h4>Weather for ${airportCode}</h4>`;
        
        if (metarText.trim()) {
            content += `<strong>METAR:</strong>\n${metarText.trim()}\n\n`;
        } else {
            content += `<strong>METAR:</strong> Not available\n\n`;
        }

        if (tafText.trim()) {
            content += `<strong>TAF:</strong>\n${tafText.trim()}`;
        } else {
            content += `<strong>TAF:</strong> Not available`;
        }

        displayElement.innerHTML = content;
    } catch (error) {
        console.error('Error fetching airport weather:', error);
        displayElement.textContent = `Error: ${error.message}. Please check the airport code and try again.`;
    }
}

async function fetchLFMLWeather() {
    const displayElement = document.getElementById('lfml-metar-taf');
    displayElement.textContent = 'Loading LFML weather...';

    const corsProxy = 'https://corsproxy.io/?';
    const timestamp = getCurrentTimestamp();
    const metarUrl = `${corsProxy}${encodeURIComponent(`https://aviationweather.gov/api/data/metar?ids=LFML&format=raw&hours=0&_=${timestamp}`)}`;
    const tafUrl = `${corsProxy}${encodeURIComponent(`https://aviationweather.gov/api/data/taf?ids=LFML&format=raw&_=${timestamp}`)}`;

    try {
        const [metarResponse, tafResponse] = await Promise.all([
            fetch(metarUrl),
            fetch(tafUrl)
        ]);

        if (!metarResponse.ok || !tafResponse.ok) {
            throw new Error('Failed to fetch LFML weather data');
        }

        const metarText = await metarResponse.text();
        const tafText = await tafResponse.text();

        let content = '';
        
        if (metarText.trim()) {
            content += `<strong>METAR:</strong>\n${metarText.trim()}\n\n`;
        } else {
            content += `<strong>METAR:</strong> Not available\n\n`;
        }

        if (tafText.trim()) {
            content += `<strong>TAF:</strong>\n${tafText.trim()}`;
        } else {
            content += `<strong>TAF:</strong> Not available`;
        }

        displayElement.innerHTML = content;
    } catch (error) {
        console.error('Error fetching LFML weather:', error);
        displayElement.textContent = `Error: ${error.message}. Please try again later.`;
    }
}
async function fetchCryptoPrices() {
    const apiKey = '73AD1E2B-B219-4DFC-9636-69C5916545E5';
    const symbols = ['BTC', 'ETH', 'SOL', 'AVAX'];
    const cryptoPricesElement = document.getElementById('crypto-prices');
    cryptoPricesElement.innerHTML = 'Loading...';

    try {
        const prices = await Promise.all(symbols.map(async (symbol) => {
            const response = await fetch(`https://rest.coinapi.io/v1/exchangerate/${symbol}/USD`, {
                headers: { 'X-CoinAPI-Key': apiKey }
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return { symbol, price: data.rate };
        }));

        let content = '';
        prices.forEach(({ symbol, price }) => {
            content += `<p><strong>${symbol}:</strong> $${price.toFixed(2)}</p>`;
        });

        cryptoPricesElement.innerHTML = content;
    } catch (error) {
        console.error('Error fetching crypto prices:', error);
        cryptoPricesElement.innerHTML = 'Error fetching prices. Please try again later.';
    }
}
</script>
</body>
</html>
