<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L8TRUST</title>
<style>
    body {
        font-family: "Courier New", Courier, monospace;
        background-color: #000080;
        color: #00FF00;
        font-size: 16px;
        line-height: 1.5;
    }
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 20px;
    }
    h1 {
        text-align: center;
        font-size: 40px;
        color: #FFFF00;
        text-shadow: 2px 2px #FF00FF;
    }
    #market-status, #major-indices, #rss-feed, #stock-ticker, #sector-performance, #stock-info, #berkshire-investments {
        border: 2px solid #00FF00;
        padding: 10px;
        margin-top: 20px;
        background-color: #000000;
        width: 100%;
        box-sizing: border-box;
    }
    #market-status {
        text-align: center;
    }
    h3 {
        color: #FF00FF;
        text-align: center;
        margin-top: 10px;
        text-decoration: underline;
    }
    .market-open { color: #00FF00; }
    .market-extended { color: #FFA500; }
    .market-closed { color: #FF0000; }
    .blink {
        animation: blinker 1s linear infinite;
    }
    @keyframes blinker {
        50% { opacity: 0; }
    }
    #refresh-info {
        text-align: center;
        font-size: 14px;
        margin-top: 20px;
        color: #FFFFFF;
    }
    #news-list {
        list-style-type: none;
        padding-left: 20px;
    }
    #news-list li {
        margin-bottom: 10px;
    }
    #news-list a {
        color: #00FF00;
        text-decoration: none;
    }
    #news-list a:hover {
        text-decoration: underline;
    }
    #major-indices {
        text-align: center;
    }
    #stock-ticker {
        overflow: hidden;
        padding: 10px 0;
        white-space: nowrap;
    }
    #ticker-content {
        display: inline-block;
        padding-left: 100%;
        animation: ticker 50s linear infinite;
    }
    #ticker-content:hover {
        animation-play-state: paused;
    }
    #ticker-content span {
        margin-right: 40px;
    }
    @keyframes ticker {
        0% { transform: translate(0, 0); }
        100% { transform: translate(-100%, 0); }
    }
    .sector-bar {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .sector-name {
        width: 150px;
        text-align: right;
        padding-right: 10px;
    }
    .bar {
        height: 20px;
        transition: width 0.5s ease-in-out;
    }
    .performance-value {
        margin-left: 5px;
    }
    #utc-clock {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 14px;
        color: #00FF00;
    }
    #stock-search {
        margin-top: 20px;
        text-align: center;
    }
    #stock-search input, #stock-search button, #load-sectors {
        font-family: "Courier New", Courier, monospace;
        font-size: 16px;
        background-color: #000000;
        color: #00FF00;
        border: 1px solid #00FF00;
        padding: 5px;
    }
    #stock-search button, #load-sectors {
        cursor: pointer;
    }
    #stock-search button:hover, #load-sectors:hover {
        background-color: #003300;
    }
    #market-status-corner {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: #000;
        border: 2px solid #00FF00;
        padding: 2px;
    }
    .pixel-traffic-light {
        display: grid;
        grid-template-columns: repeat(5, 6px);
        grid-template-rows: repeat(7, 6px);
        gap: 1px;
    }
    .pixel {
        width: 6px;
        height: 6px;
        background-color: #333;
    }
    .pixel.on {
        background-color: #000;
    }
    .pixel.red.on { background-color: #FF0000; }
    .pixel.yellow.on { background-color: #FFFF00; }
    .pixel.green.on { background-color: #00FF00; }
    #sector-performance {
        margin-top: 20px;
        text-align: center;
    }
    #sector-title {
        color: #FF00FF;
        text-align: center;
        margin-top: 0;
        margin-bottom: 20px;
        text-decoration: underline;
    }
    #berkshire-form4-button {
        display: block;
        position: absolute;
        top: 25px;
        right: 10px;
        margin: 10px auto;
        padding: 5px 10px;
        background-color: #000000;
        color: #00FF00;
        border: 1px solid #00FF00;
        cursor: pointer;
        font-family: "Courier New", Courier, monospace;
        font-size: 16px;
    }
    #berkshire-form4-button:hover {
        background-color: #003300;
    }
</style>
</head>
<body>
<div class="container">
    <div id="market-status-corner">
        <div class="pixel-traffic-light">
            <!-- 5x7 grid of pixels will be created here by JavaScript -->
        </div>
    </div>
    <div id="utc-clock"></div>
    <button id="berkshire-form4-button">Latest Berkshire Form 4</button>
    <h1 class="blink">L8TRUST</h1>
    <div id="market-status"></div>
    <div id="major-indices">
        <h3>Major Indices</h3>
        <p>
            <span id="spy-performance">S&P 500: -1.12%</span> |
            <span id="qqq-performance">Nasdaq 100: -2.33%</span> |
            <span id="dia-performance">Dow Jones: 0.18%</span>
        </p>
    </div>
    <div id="stock-ticker">
        <div id="ticker-content"></div>
    </div>
    <div id="stock-search">
        <input type="text" id="stock-symbol" placeholder="Enter stock symbol">
        <button onclick="searchStock()">Search</button>
        <button onclick="resetSearch()">Reset</button>
    </div>
    <div id="stock-info"></div>
    <div id="sector-performance">
        <button id="load-sectors">Load Sector Performance</button>
        <div id="sector-chart" style="display: none;">
            <h3 id="sector-title">Sector Performance</h3>
            <!-- Sector data will be loaded here -->
        </div>
    </div>
    <div id="rss-feed">
        <h3>Latest News</h3>
        <ul id="news-list"></ul>
    </div>
    <div id="refresh-info">This page will refresh in <span id="countdown">120</span> seconds</div>
</div>
<script>
    const apiKey = 'cha3cg1r01qhe0r9rhg0cha3cg1r01qhe0r9rhgg';
    const marketStatusApiKey = 'NQpPDWBnyk3zbab7leFzAavOzTnNpWjY';
    let countdown = 120;

    async function fetchMarketStatus() {
        const marketStatusUrl = `https://api.polygon.io/v1/marketstatus/now?apiKey=${marketStatusApiKey}`;
        try {
            const response = await fetch(marketStatusUrl);
            const data = await response.json();
            if (!data || data.error) {
                throw new Error(data ? data.error : 'Unknown error');
            }
            displayMarketStatus(data);
        } catch (error) {
            console.error('Error fetching market status:', error);
            document.getElementById('market-status').innerHTML = `
                <p>Error fetching market status. ${error.message}</p>
                <p>Check the console for more details.</p>
            `;
        }
    }

    function displayMarketStatus(statusData) {
        const marketStatusElement = document.getElementById('market-status');
        const nyseStatus = statusData.exchanges.nyse;
        const nasdaqStatus = statusData.exchanges.nasdaq;

        const nyseColorClass = (nyseStatus === 'open') 
            ? 'market-open' 
            : (nyseStatus === 'extended-hours') 
            ? 'market-extended' 
            : 'market-closed';

        const nasdaqColorClass = (nasdaqStatus === 'open') 
            ? 'market-open' 
            : (nasdaqStatus === 'extended-hours') 
            ? 'market-extended' 
            : 'market-closed';

        marketStatusElement.innerHTML = `NYSE: 
            <span class="${nyseColorClass}">${nyseStatus}</span>, NASDAQ: 
            <span class="${nasdaqColorClass}">${nasdaqStatus}</span>`;

        const isOpen = nyseStatus === 'open' || nasdaqStatus === 'open';
        const isExtended = nyseStatus === 'extended-hours' || nasdaqStatus === 'extended-hours';
        
        updateTrafficLight(isOpen ? 'open' : (isExtended ? 'extended' : 'closed'));
    }

    async function fetchIndexPerformance(symbol) {
        const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`;
        const response = await fetch(url);
        const data = await response.json();
        const changePercent = ((data.c - data.pc) / data.pc * 100).toFixed(2);
        return `${changePercent}%`;
    }

    async function displayIndexPerformance(symbol, elementId, indexName) {
        const performanceElement = document.getElementById(elementId);
        try {
            const changePercent = await fetchIndexPerformance(symbol);
            if (performanceElement) {
                const spanElement = document.createElement('span');
                const numericChange = parseFloat(changePercent);
                spanElement.textContent = `${numericChange >= 0 ? '+' : ''}${changePercent}`;
                const changeColor = numericChange >= 0 ? '#00FF00' : '#FF4500';
                spanElement.style.backgroundColor = changeColor;
                spanElement.style.color = 'black';
                spanElement.style.padding = '2px 5px';
                spanElement.style.borderRadius = '3px';
                spanElement.style.fontWeight = 'bold';
                performanceElement.innerHTML = `${indexName}: `;
                performanceElement.appendChild(spanElement);
            }
        } catch (error) {
            console.error(`Error displaying ${indexName} performance:`, error);
            if (performanceElement) {
                performanceElement.textContent = `Error displaying ${indexName} performance.`;
            }
        }
    }

    async function loadRSSFeed() {
        const rssUrl = 'https://breakingthenews.net/news-feed.xml';
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(rssUrl)}`;
        
        try {
            const response = await fetch(proxyUrl);
            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            
            const items = xmlDoc.querySelectorAll('item');
            const newsList = document.getElementById('news-list');
            newsList.innerHTML = '';
            
            items.forEach(item => {
                const title = item.querySelector('title').textContent;
                const link = item.querySelector('link').textContent;
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = link;
                a.textContent = title;
                li.appendChild(a);
                newsList.appendChild(li);
            });
        } catch (error) {
            console.error('Error fetching RSS feed:', error);
            document.getElementById('news-list').innerHTML = '<li>Error loading news feed. Please try again later.</li>';
        }
    }

    async function fetchStockData(symbol) {
        const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`;
        const response = await fetch(url);
        const data = await response.json();
        const changePercent = ((data.c - data.pc) / data.pc * 100).toFixed(2);
        return { symbol, price: data.c.toFixed(2), changePercent };
    }

    async function updateStockTicker() {
        const stocks = ['AAPL', 'MSFT', 'NVDA', 'GOOGL', 'AMZN', 'META', 'BRK-B', 'TSM', 'LLY', 'TSLA'];
        const tickerContent = document.getElementById('ticker-content');
        tickerContent.innerHTML = '';

        for (const stock of stocks) {
            try {
                const { symbol, price, changePercent } = await fetchStockData(stock);
                const numericChange = parseFloat(changePercent);
                const changeColor = numericChange >= 0 ? '#00FF00' : '#FF4500';
                const changeSign = numericChange >= 0 ? '+' : '';
                
                tickerContent.innerHTML += `
                    <span>${symbol}: $${price} 
                        <span style="background-color: ${changeColor}; color: black; padding: 2px 5px; border-radius: 3px; font-weight: bold;">
                            ${changeSign}${changePercent}%
                        </span>
                    </span>
                `;
            } catch (error) {
                console.error(`Error fetching data for ${stock}:`, error);
            }
        }
    }

    async function fetchSectorPerformance() {
        const sectors = [
            { symbol: 'XLK', name: 'Technology' },
            { symbol: 'XLV', name: 'Healthcare' },
            { symbol: 'XLF', name: 'Financials' },
            { symbol: 'XLE', name: 'Energy' },
            { symbol: 'XLY', name: 'Consumer Cyclical' }
        ];

        const sectorPerformance = [];

        for (const sector of sectors) {
            try {
                const { symbol, name } = sector;
                const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`;
                const response = await fetch(url);
                const data = await response.json();
                const performance = ((data.c - data.pc) / data.pc * 100);
                sectorPerformance.push({ name, performance });
            } catch (error) {
                console.error(`Error fetching data for ${sector.name}:`, error);
                sectorPerformance.push({ name: sector.name, performance: 0 });
            }
        }

        updateSectorChart(sectorPerformance);
    }

    function updateSectorChart(sectorData) {
        const chartContainer = document.getElementById('sector-chart');
        chartContainer.innerHTML = '<h3 id="sector-title">Sector Performance</h3>';

        sectorData.sort((a, b) => b.performance - a.performance);
        const maxPerformance = Math.max(...sectorData.map(s => Math.abs(s.performance)));

        sectorData.forEach(sector => {
            const sectorDiv = document.createElement('div');
            sectorDiv.className = 'sector-bar';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'sector-name';
            nameSpan.textContent = sector.name;

            const barDiv = document.createElement('div');
            barDiv.className = 'bar';
            const width = Math.abs(sector.performance) / maxPerformance * 70;
            barDiv.style.width = `${width}%`;
            barDiv.style.backgroundColor = sector.performance >= 0 ? '#00FF00' : '#FF0000';

            const valueSpan = document.createElement('span');
            valueSpan.className = 'performance-value';
            valueSpan.textContent = `${sector.performance > 0 ? '+' : ''}${sector.performance.toFixed(2)}%`;
            valueSpan.style.color = sector.performance >= 0 ? '#00FF00' : '#FF0000';

            sectorDiv.appendChild(nameSpan);
            sectorDiv.appendChild(barDiv);
            sectorDiv.appendChild(valueSpan);

            chartContainer.appendChild(sectorDiv);
        });
    }

    async function searchStock() {
        const symbol = document.getElementById('stock-symbol').value.toUpperCase();
        const stockInfoElement = document.getElementById('stock-info');
        stockInfoElement.innerHTML = 'Loading...';
        try {
            const quoteUrl = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`;
            const profileUrl = `https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${apiKey}`;
            const [quoteResponse, profileResponse] = await Promise.all([
                fetch(quoteUrl),
                fetch(profileUrl)
            ]);
            const quoteData = await quoteResponse.json();
            const profileData = await profileResponse.json();
            if (quoteData.error || profileData.error) {
                throw new Error('Stock not found');
            }
            const marketCap = (profileData.marketCapitalization * 1000000).toLocaleString();
            const peRatio = (quoteData.c / (profileData.finnhubIndustry === 'Technology' ? 20 : 15)).toFixed(2);
            
            const percentChange = ((quoteData.c - quoteData.pc) / quoteData.pc * 100).toFixed(2);
            const changeSign = percentChange >= 0 ? '+' : '';
            const changeColor = percentChange >= 0 ? '#00FF00' : '#FF4500';

            stockInfoElement.innerHTML = `
                <h3>${profileData.name} (${symbol})</h3>
                <p><strong>Industry:</strong> ${profileData.finnhubIndustry}</p>
                <p><strong>Price:</strong> $${quoteData.c.toFixed(2)} 
                   <span style="background-color: ${changeColor}; color: black; padding: 2px 5px; border-radius: 3px; font-weight: bold;">
                     (${changeSign}${percentChange}%)
                   </span>
                </p>
                <p><strong>Market Cap:</strong> $${marketCap}</p>
                <p><strong>Day's High:</strong> $${quoteData.h.toFixed(2)}</p>
                <p><strong>Day's Low:</strong> $${quoteData.l.toFixed(2)}</p>
            `;
        } catch (error) {
            console.error('Error fetching stock data:', error);
            stockInfoElement.innerHTML = 'Error fetching stock data. Please try again.';
        }
    }

    function resetSearch() {
        document.getElementById('stock-symbol').value = '';
        document.getElementById('stock-info').innerHTML = '';
    }

    function updateUTCClock() {
        const now = new Date();
        const utcString = now.toUTCString();
        document.getElementById('utc-clock').textContent = utcString;
    }

    function refreshAllData() {
        fetchMarketStatus();
        displayIndexPerformance('SPY', 'spy-performance', 'S&P 500');
        displayIndexPerformance('QQQ', 'qqq-performance', 'Nasdaq 100');
        displayIndexPerformance('DIA', 'dia-performance', 'Dow Jones');
        updateStockTicker();
        loadRSSFeed();
        updateUTCClock();
        countdown = 120;
    }

    function updateCountdown() {
        countdown--;
        document.getElementById('countdown').textContent = countdown;
        if (countdown <= 0) {
            refreshAllData();
        }
    }

    function createPixelTrafficLight() {
        const lightContainer = document.querySelector('.pixel-traffic-light');
        const pixelStates = [
            0,0,1,0,0,
            0,1,1,1,0,
            1,1,1,1,1,
            1,1,1,1,1,
            1,1,1,1,1,
            0,1,1,1,0,
            0,0,1,0,0
        ];
        
        pixelStates.forEach((state, index) => {
            const pixel = document.createElement('div');
            pixel.className = `pixel ${state ? 'on' : ''}`;
            if (index < 15) pixel.classList.add('red');
            else if (index < 25) pixel.classList.add('yellow');
            else pixel.classList.add('green');
            lightContainer.appendChild(pixel);
        });
    }

    function updateTrafficLight(status) {
        const redPixels = document.querySelectorAll('.pixel.red');
        const yellowPixels = document.querySelectorAll('.pixel.yellow');
        const greenPixels = document.querySelectorAll('.pixel.green');
        
        [redPixels, yellowPixels, greenPixels].forEach(pixels => 
            pixels.forEach(pixel => pixel.classList.remove('on'))
        );

        if (status === 'closed') {
            redPixels.forEach(pixel => pixel.classList.add('on'));
        } else if (status === 'extended') {
            yellowPixels.forEach(pixel => pixel.classList.add('on'));
        } else if (status === 'open') {
            greenPixels.forEach(pixel => pixel.classList.add('on'));
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        createPixelTrafficLight();
        refreshAllData();
        setInterval(updateCountdown, 1000);
        setInterval(updateUTCClock, 1000);
        
        const loadSectorsButton = document.getElementById('load-sectors');
        loadSectorsButton.addEventListener('click', async () => {
            const sectorChart = document.getElementById('sector-chart');
            if (sectorChart.style.display === 'none') {
                loadSectorsButton.disabled = true;
                loadSectorsButton.textContent = 'Loading...';
                sectorChart.style.display = 'block';
                try {
                    await fetchSectorPerformance();
                    loadSectorsButton.textContent = 'Hide Sector Performance';
                } catch (error) {
                    console.error('Error loading sector performance:', error);
                    sectorChart.innerHTML = 'Error loading sector performance. Please try again.';
                }
                loadSectorsButton.disabled = false;
            } else {
                sectorChart.style.display = 'none';
                loadSectorsButton.textContent = 'Load Sector Performance';
            }
        });

        const berkshireButton = document.getElementById('berkshire-form4-button');
        berkshireButton.addEventListener('click', async () => {
            const formData = await fetchLatestBerkshireForm4();
            if (formData) {
                displayForm4Popup(formData);
            } else {
                alert('Error fetching Berkshire Form 4 data. Please try again later.');
            }
        });
    });

    async function fetchLatestBerkshireForm4() {
        const proxyUrl = 'https://api.allorigins.win/raw?url=';
        const edgarUrl = 'https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK=0001067983&type=4&dateb=&owner=include&start=0&count=1&output=atom';
        const fullUrl = proxyUrl + encodeURIComponent(edgarUrl);

        try {
            const response = await fetch(fullUrl);
            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            
            const entry = xmlDoc.querySelector('entry');
            const title = entry.querySelector('title').textContent;
            const link = entry.querySelector('link').getAttribute('href');
            const date = new Date(entry.querySelector('updated').textContent);
            
            return { title, link, date };
        } catch (error) {
            console.error('Error fetching Berkshire Form 4:', error);
            return null;
        }
    }

    function displayForm4Popup(formData) {
        const popup = document.createElement('div');
        popup.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #000000;
            border: 2px solid #00FF00;
            padding: 20px;
            z-index: 1000;
            color: #00FF00;
            font-family: "Courier New", Courier, monospace;
        `;

        popup.innerHTML = `
            <h3>Latest Berkshire Hathaway Form 4</h3>
            <p><strong>Title:</strong> ${formData.title}</p>
            <p><strong>Filed on:</strong> ${formData.date.toLocaleDateString()}</p>
            <a href="${formData.link}" target="_blank" style="color: #00FF00;">View Full Form</a>
            <button id="close-popup" style="
                background-color: #000000;
                color: #00FF00;
                border: 1px solid #00FF00;
                padding: 5px 10px;
                margin-top: 10px;
                cursor: pointer;
                font-family: "Courier New", Courier, monospace;
            ">Close</button>
        `;

        document.body.appendChild(popup);

        document.getElementById('close-popup').addEventListener('click', () => {
            document.body.removeChild(popup);
        });
    }
</script>
</body>
</html>
